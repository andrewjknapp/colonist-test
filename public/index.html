<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<link rel="stylesheet" href="style.css">
	<title>Ping Pong Game</title>
</head>
<body>
	<canvas id="canvas" width="800" height="400"></canvas>
	<script type="text/javascript" src="js/app.js"></script>
	<script type="text/javascript">
		
		app.isPaused = true;
		app.keyupBindings = {};
		app.keydownBindings = {};

		const BALL_INITIAL_SPEED = 30;
		const sharedPlayerAttributes = {
			width  : 20,
			height : 100,
			speed  : 15,
			direction : 0,
		}
		let player1Node;
		let player2Node;
		let ballNode;
		let ballVerticalSpeed = (Math.random() * BALL_INITIAL_SPEED) - BALL_INITIAL_SPEED / 2;
		let ballHorizontalSpeed = (Math.random() * BALL_INITIAL_SPEED) - BALL_INITIAL_SPEED / 2;
		

		app.pause = function() {
			this.isPaused = !this.isPaused;
			ballNode = this.getNode('ball')

			if (this.isPaused) {
				ballHorizontalSpeed = ballNode.dx;
				ballVerticalSpeed = ballNode.dy;
				ballNode.dy = 0;
				ballNode.dx = 0;
			}
			else {
				ballNode.dx = ballHorizontalSpeed;
				ballNode.dy = ballVerticalSpeed;
			}
		}
		
		app.onInit = function(){
			const canvas = document.getElementById("canvas");
			canvas.width = window.innerWidth;
			this.width = window.innerWidth;
			canvas.height = window.innerHeight;
			this.height = window.innerHeight;

			this.isPaused = true;
		
			// Create Nodes for Player1, Player2, and Ball
			this.nodes.push({
				id : "player1",
				x  : 100,
				y  : (app.height / 2) - 50,
				color : "red",
				...sharedPlayerAttributes,
			})

			this.nodes.push({
				id : "player2",
				x  : app.width - 120,
				y  : (app.height / 2) - 50,
				color: "green",
				...sharedPlayerAttributes,
			})

			this.nodes.push({
				id : "ball",
				x  : (app.width / 2) - 10,
				y  : (app.height / 2) - 10,
				color  : "blue",
				width  : 20,
				height : 20,
				speed  : 5,
				dy : 0,
				dx : 0,
			})

			this.keydownBindings = {
				"w": () => (this.getNode('player1').direction = -1),
				"s": () => (this.getNode('player1').direction = 1),
				"ArrowUp": () => (this.getNode('player2').direction = -1),
				"ArrowDown": () => (this.getNode('player2').direction = 1),
			}

			this.keyupBindings = {
				"w": () => (this.getNode('player1').direction = 0),
				"s": () => (this.getNode('player1').direction = 0),
				"ArrowUp": () => (this.getNode('player2').direction = 0),
				"ArrowDown": () => (this.getNode('player2').direction = 0),
			}
		};

		app.onUpdate = function(time){
			// Store in variables to prevent recalling
			// getNode O(n) lookup each time it is used
			player1Node = this.getNode('player1');
			player2Node = this.getNode('player2');
			ballNode = this.getNode('ball');

			// Control Player Movement
			handlePlayerMovement(player1Node);
			handlePlayerMovement(player2Node);

			// Handle Ball Movement and interractions
			// Bounce off cieling and floor
			if (ballNode.y <= 0 || ballNode.y >= (app.height - ballNode.height)) {
				ballNode.dy *= -1;
			}
			// If Ball makes contact with Player1's paddle
			if (ballNode.x <= (player1Node.x + player1Node.width) && 
			ballNode.x >= (player1Node.x + player1Node.width / 2) && 
			ballNode.y >= player1Node.y && ballNode.y <= player1Node.y + player1Node.height) {
				ballNode.dx *= -1;
			}	
			// If Ball makes contact with Player2's paddle
			else if (ballNode.x + ballNode.width >= player2Node.x && ballNode.x + ballNode.width <= player2Node.x + (player2Node.width / 2) &&
			ballNode.y >= player2Node.y && ballNode.y <= player2Node.y + player2Node.height) {
				ballNode.dx *= -1
			}
			else if (ballNode.x <= 0 || ballNode.x >= (app.width - ballNode.width)) {
				ballNode.dx *= -1;
			} 
			
			ballNode.x += ballNode.dx;
			ballNode.y += ballNode.dy;
			
		};
		// Bounce off back walls

		const handlePlayerMovement = (player) => {
				// If the player is within the canvas allow to move *OR*
			if (player.y > 0 && player.y < app.height - player.height ||
				// If player is at top boundary, prevent from going upward *OR*
				player.y === 0 && player.direction != -1 ||
				// If player is at bottom boundary, prevent from going downward
				player.y === app.height - player.height && player.direction != 1) {

				player.y += player.direction * player.speed;
			}
			// If the player is above the top, set y to top.
			else if (player.y < 0) {
				player.y = 0;
			}
			// If the player is below the bottom, set y to bottom.
			else if (player.y > app.height - player.height) {
				player.y = app.height - player.height;
			}
		}

		document.addEventListener("keydown", (e) => {
			let action = app.keydownBindings[e.key];
			if (action) {
				action();
			};

			if (e.key === " ") {
				app.pause();
			}
		})

		document.addEventListener("keyup", (e) => {
			let action = app.keyupBindings[e.key];
			if (action) {
				action();
			};
		})
		
	</script>
</body>
</html>